#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Pre-commit hook: block committing obvious secrets or .env files
# Scans staged diff for secret patterns and prints file + line (not the secret value)
echo "ðŸ”’ Running pre-commit secret scan..."

# 1) block files by name
staged_files=$(git diff --cached --name-only --diff-filter=ACM)
echo "$staged_files" | grep -E "(^|/)\.env($|/)|(^|/)\.env\..*|credentials.*\.json" >/dev/null 2>&1
if [ $? -eq 0 ]; then
  echo "ERROR: Attempt to commit .env or credentials file. Remove secrets before committing." >&2
  echo "$staged_files" | grep -E "(^|/)\.env($|/)|(^|/)\.env\..*|credentials.*\.json" >&2
  exit 1
fi

# 2) scan staged diffs for secret patterns
git diff --cached --no-color | grep -n -E -i "sk-[A-Za-z0-9_-]{20,}|AKIA[0-9A-Z]{16}|secret[_-]?key|-----BEGIN (RSA|EC|PRIVATE) KEY-----|TWILIO_AUTH_TOKEN\s*=\s*.+|SENDGRID_API_KEY\s*=\s*.+" >/dev/null 2>&1
if [ $? -eq 0 ]; then
  echo "ERROR: Potential secret detected in staged changes. Aborting commit." >&2
  echo "Matching lines (line numbers from diff):" >&2
  git diff --cached --no-color | grep -n -E -i "sk-[A-Za-z0-9_-]{20,}|AKIA[0-9A-Z]{16}|secret[_-]?key|-----BEGIN (RSA|EC|PRIVATE) KEY-----|TWILIO_AUTH_TOKEN\s*=\s*.+|SENDGRID_API_KEY\s*=\s*.+" | head -20 >&2
  exit 1
fi

echo "âœ… No obvious secrets found. Proceeding with commit."
exit 0
