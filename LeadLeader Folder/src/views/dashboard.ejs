<!DOCTYPE html>
<html>
<head>
  <%- include('partials/head') %>
</head>
<body>
  <main class="container" style="max-width:1000px;margin:32px auto;padding:16px">
    <% if (typeof quotaUsage !== 'undefined' && quotaUsage && quotaUsage.used / quotaUsage.limit >= 0.8) { %>
      <div role="alert" style="padding:16px;margin-bottom:24px;border-radius:8px;background:<%= quotaUsage.remaining === 0 ? 'var(--error-bg, #dc2626)' : 'orange' %>;color:white;display:flex;align-items:center;gap:12px">
        <span style="font-size:24px">‚ö†Ô∏è</span>
        <div>
          <div style="font-weight:600;margin-bottom:4px">
            <% if (quotaUsage.remaining === 0) { %>
              Daily quota limit reached
            <% } else { %>
              Approaching daily quota limit
            <% } %>
          </div>
          <div style="font-size:14px;opacity:0.9">
            <%= quotaUsage.used %>/<%= quotaUsage.limit %> contact submissions used today
            <% if (quotaUsage.remaining > 0) { %>
              (<%= quotaUsage.remaining %> remaining)
            <% } %>
          </div>
        </div>
      </div>
    <% } %>
    
    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:24px;flex-wrap:wrap;gap:16px">
      <h1 style="margin:0">Dashboard</h1>
      
      <% if (typeof quotaUsage !== 'undefined' && quotaUsage) { %>
        <div style="padding:12px 16px;background:var(--card-bg);border:1px solid var(--border-color);border-radius:8px">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Today's Contact Quota</div>
          <div style="font-size:20px;font-weight:600;color:var(--text-primary)">
            <%= quotaUsage.used %>/<%= quotaUsage.limit %>
            <% if (typeof plan !== 'undefined' && plan) { %>
              <span style="font-size:12px;margin-left:8px;padding:3px 8px;background:var(--link-color);color:white;border-radius:4px;text-transform:uppercase"><%= plan %></span>
            <% } %>
          </div>
          <% if (quotaUsage.remaining === 0) { %>
            <div style="font-size:12px;color:var(--error-text);margin-top:4px">‚ö†Ô∏è Limit reached</div>
          <% } else if (quotaUsage.remaining <= 2) { %>
            <div style="font-size:12px;color:orange;margin-top:4px">‚ö†Ô∏è <%= quotaUsage.remaining %> remaining</div>
          <% } %>
        </div>
      <% } %>
    </div>
    
    <% if (events && events.length > 0) { %>
      <div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center" role="group" aria-label="Event filters">
        <span style="font-size:14px;color:var(--text-muted);margin-right:4px">Filter:</span>
        <button class="filter-btn active" data-filter="all" aria-pressed="true" style="padding:6px 12px;background:var(--link-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:13px">All</button>
        <button class="filter-btn" data-filter="contact_submitted" aria-pressed="false" style="padding:6px 12px;background:var(--card-bg);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;font-size:13px">Contacts</button>
        <button class="filter-btn" data-filter="system" aria-pressed="false" style="padding:6px 12px;background:var(--card-bg);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;font-size:13px">System</button>
        
        <span style="margin-left:auto;font-size:14px;color:var(--text-muted);display:flex;gap:8px;align-items:center">
          <label for="limit-select">Show:</label>
          <select id="limit-select" onchange="window.location.href='/dashboard?limit='+this.value" style="padding:4px 8px;background:var(--input-bg);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;font-size:13px">
            <option value="10" <%= (limit || 50) === 10 ? 'selected' : '' %>>10</option>
            <option value="50" <%= (limit || 50) === 50 ? 'selected' : '' %>>50</option>
            <option value="100" <%= (limit || 50) === 100 ? 'selected' : '' %>>100</option>
          </select>
        </span>
      </div>
      
      <div style="display:grid;gap:12px" id="events-container">
        <% events.forEach(event => { %>
          <div class="card event-card" data-type="<%= event.type %>" style="border:1px solid var(--border-color);border-radius:8px;padding:16px;background:var(--card-bg)">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
              <span style="font-weight:600;text-transform:uppercase;font-size:12px;color:var(--link-color)">
                <%= event.type %>
              </span>
              <span style="font-size:13px;color:var(--text-muted)">
                <%= new Date(event.createdAt).toLocaleString() %>
              </span>
            </div>
            <div style="font-size:14px;color:var(--text-secondary);background:var(--input-bg);padding:12px;border-radius:4px;overflow:auto;max-height:200px">
              <pre style="margin:0;font-family:monospace;font-size:12px;white-space:pre-wrap"><%= JSON.stringify(event.payload, null, 2) %></pre>
            </div>
          </div>
        <% }) %>
      </div>
      
      <% if (nextOffset) { %>
        <div style="margin-top:16px;text-align:center">
          <a href="/dashboard?offset=<%= nextOffset %>&limit=<%= limit || 50 %>" style="color:var(--link-color)">Load more ‚Üí</a>
        </div>
      <% } %>
      
      <script>
        // Event filtering
        const filterBtns = document.querySelectorAll('.filter-btn');
        const eventCards = document.querySelectorAll('.event-card');
        
        filterBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const filter = btn.dataset.filter;
            
            // Update active state and aria-pressed
            filterBtns.forEach(b => {
              b.classList.remove('active');
              b.setAttribute('aria-pressed', 'false');
              b.style.background = 'var(--card-bg)';
              b.style.color = 'var(--text-primary)';
            });
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
            btn.style.background = 'var(--link-color)';
            btn.style.color = 'white';
            
            // Filter events
            eventCards.forEach(card => {
              if (filter === 'all' || card.dataset.type === filter) {
                card.style.display = 'block';
              } else {
                card.style.display = 'none';
              }
            });
          });
        });
      </script>
    <% } else { %>
      <div class="card" style="border:1px solid var(--border-color);border-radius:8px;padding:48px 32px;text-align:center;background:var(--card-bg)">
        <div style="font-size:48px;margin-bottom:16px;opacity:0.5">üìã</div>
        <h2 style="margin:0 0 8px 0;color:var(--text-primary)">No Activity Yet</h2>
        <p style="color:var(--text-muted);margin:0 0 24px 0">Your dashboard will show events once you start using the platform.</p>
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
          <a href="/try" style="padding:10px 20px;background:var(--button-bg);color:var(--button-text);border-radius:6px;text-decoration:none;display:inline-block">Try Contact Form</a>
          <a href="/contact" style="padding:10px 20px;background:transparent;color:var(--link-color);border:1px solid var(--link-color);border-radius:6px;text-decoration:none;display:inline-block">Contact Owner</a>
        </div>
      </div>
    <% } %>
  </main>
  
  <%- include('partials/foot') %>
</body>
</html>
