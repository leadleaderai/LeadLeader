<%- include('partials/head', { title: title || 'Owner: Users' }) %>
<h1>Owner: Users</h1>
<p>Owner (<code>LeadLeaderCeo</code>) is env-only and cannot be edited here.</p>
<table border="1" cellpadding="6" cellspacing="0">
  <thead><tr><th>Username</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
  <tbody>
    <% (users||[]).forEach(u=>{ %>
      <tr>
        <td><%= u.username %></td>
        <td>
          <select data-username="<%= u.username %>" class="roleSel">
            <option value="user" <%= u.role==='user'?'selected':'' %>>user</option>
            <option value="mod"  <%= u.role==='mod'?'selected':'' %>>mod</option>
          </select>
        </td>
        <td><%= u.createdAt %></td>
        <td>
          <button class="renameBtn" data-username="<%= u.username %>" style="margin-right:4px">Rename</button>
          <button class="resetBtn"  data-username="<%= u.username %>" style="margin-right:4px">Reset Password</button>
          <button class="deleteBtn" data-username="<%= u.username %>" style="background:var(--error-bg);color:var(--error-text)">Delete</button>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>
<script>
async function j(url,body){const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});return r.json()}
document.querySelectorAll('.roleSel').forEach(s=>s.addEventListener('change',async()=>{const out=await j('/owner/users/role',{username:s.dataset.username,role:s.value}); if(!out.ok) alert(out.error||'Role update failed')}));
document.querySelectorAll('.renameBtn').forEach(b=>b.addEventListener('click',async()=>{const oldName=b.dataset.username; const nn=prompt('New username for '+oldName+':'); if(!nn) return; const out=await j('/owner/users/rename',{oldName:oldName,newName:nn}); if(out.ok) location.reload(); else alert(out.error||'Rename failed')}));
document.querySelectorAll('.resetBtn').forEach(b=>b.addEventListener('click',async()=>{const u=b.dataset.username; const p=prompt('New password for '+u+': (min 8 chars)'); if(!p) return; const out=await j('/owner/users/reset',{username:u,newPassword:p}); if(!out.ok) alert(out.error||'Reset failed')}));
document.querySelectorAll('.deleteBtn').forEach(b=>b.addEventListener('click',async()=>{const u=b.dataset.username; if(!confirm('Delete user '+u+'? This cannot be undone.')) return; const out=await j('/owner/users/delete',{username:u}); if(out.ok) location.reload(); else alert(out.error||'Delete failed')}));
</script>
<%- include('partials/foot') %>
